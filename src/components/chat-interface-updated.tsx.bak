import React, { useState, useEffect, useRef } from 'react';
import svgPaths from "../imports/svg-r2niu2bn0c";
import ChatMassageIncome from "../imports/ChatMassageIncome";
import { CitizenshipSelector } from "./citizenship-selector";
import { BusinessActivitySelector } from "./business-activity-selector";
import { CompanyNameSelector } from "./company-name-selector";
import { PaymentMessage } from "./payment-message";
import { PaymentModal } from "./payment-modal";
import { PaymentSuccess } from "./payment-success";
import Frame75DocumentsMessage from "../imports/Frame75-15-2298";
import Frame157PDFMessage from "../imports/Frame157";

// Message types
type Message = {
  id: string;
  content: string;
  isBot: boolean;
  timestamp: Date;
  isTyping?: boolean;
  hasButton?: boolean;
  onButtonClick?: () => void;
  hasCitizenshipSelector?: boolean;
  shareholderName?: string;
  hasBusinessActivitySelector?: boolean;
  hasCompanyNameSelector?: boolean;
  hasDocumentsMessage?: boolean;
  hasPaymentMessage?: boolean;
  isPDFAttachment?: boolean;
};

// Typing animation component
function TypingAnimation() {
  return (
    <div className="flex gap-1 items-center py-2">
      <div className="w-2 h-2 bg-muted-foreground rounded-full animate-bounce" style={{ animationDelay: '0ms' }} />
      <div className="w-2 h-2 bg-muted-foreground rounded-full animate-bounce" style={{ animationDelay: '150ms' }} />
      <div className="w-2 h-2 bg-muted-foreground rounded-full animate-bounce" style={{ animationDelay: '300ms' }} />
    </div>
  );
}

// No typing animation - just show complete text
function useSimpleDisplay(text: string, onComplete?: () => void) {
  useEffect(() => {
    if (onComplete && text) {
      onComplete();
    }
  }, [text, onComplete]);

  return { displayedText: text, isComplete: true };
}

// Special message component with button
function BotMessageWithButton({ content, onButtonClick }: { content: string, onButtonClick: () => void }) {
  return (
    <div className="flex justify-start w-full pr-4">
      <div className="flex-1">
        <div className="flex flex-col gap-4">
          <ChatMassageIncome content={content} />
          <div className="flex justify-start">
            <button 
              onClick={onButtonClick}
              className="bg-primary rounded-lg px-4 py-2.5 transition-colors hover:bg-primary/90 active:bg-primary/80"
            >
              <span className="!text-[16px] text-primary-foreground">Start</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// Message component without typing animation
function ChatMessage({ 
  message, 
  onComplete, 
  onCitizenshipSelect, 
  onBusinessActivitiesSelect, 
  onCompanyNamesSelect,
  onPayClick,
  businessActivities,
  waitingForBusinessActivities 
}: { 
  message: Message, 
  onComplete?: () => void, 
  onCitizenshipSelect?: (country: string) => void, 
  onBusinessActivitiesSelect?: (activities: string[]) => void, 
  onCompanyNamesSelect?: (names: string[]) => void,
  onPayClick?: () => void,
  businessActivities?: string[],
  waitingForBusinessActivities?: boolean
}) {
  const { displayedText } = useSimpleDisplay(
    message.isBot && !message.isTyping ? message.content : '',
    onComplete
  );

  const content = message.isBot && !message.isTyping ? displayedText : message.content;

  if (message.isTyping) {
    return (
      <div className="flex justify-start w-full">
        <div className="max-w-[80%] bg-muted rounded-2xl px-4 py-3">
          <TypingAnimation />
        </div>
      </div>
    );
  }

  if (message.isBot) {
    // Special message with payment request
    if (message.hasPaymentMessage && onPayClick) {
      return <PaymentMessage onPayClick={onPayClick} />;
    }
    
    // Special message with documents request
    if (message.hasDocumentsMessage) {
      return (
        <div className="flex justify-start w-full pr-4">
          <div className="flex-1">
            <Frame75DocumentsMessage />
          </div>
        </div>
      );
    }
    
    // Special message with company name selector
    if (message.hasCompanyNameSelector && onCompanyNamesSelect) {
      return (
        <CompanyNameSelector 
          onComplete={onCompanyNamesSelect} 
        />
      );
    }
    
    // Special message with business activity selector
    if (message.hasBusinessActivitySelector && onBusinessActivitiesSelect) {
      const isCompleted = !waitingForBusinessActivities && businessActivities && businessActivities.length > 0;
      return (
        <BusinessActivitySelector 
          onComplete={onBusinessActivitiesSelect}
          isCompleted={isCompleted}
          completedActivities={businessActivities || []}
        />
      );
    }
    
    // Special message with citizenship selector
    if (message.hasCitizenshipSelector && message.shareholderName && onCitizenshipSelect) {
      return (
        <CitizenshipSelector 
          shareholderName={message.shareholderName} 
          onSelect={onCitizenshipSelect} 
        />
      );
    }
    
    // Special message with button
    if (message.hasButton && message.onButtonClick) {
      return <BotMessageWithButton content={content} onButtonClick={message.onButtonClick} />;
    }
    
    return (
      <div className="flex justify-start w-full pr-4">
        <div className="flex-1">
          <ChatMassageIncome content={content} />
        </div>
      </div>
    );
  }

  // PDF attachment message
  if (message.isPDFAttachment) {
    return (
      <div className="flex justify-end w-full">
        <Frame157PDFMessage />
      </div>
    );
  }

  return (
    <div className="flex justify-end w-full">
      <div className="bg-muted border border-border rounded-[20px] px-[14px] py-[12px] max-w-[280px]">
        <p className="!text-[16px] text-foreground leading-relaxed">{content}</p>
      </div>
    </div>
  );
}

// Header components
function MenuIcon() {
  return (
    <div className="w-6 h-6">
      <svg className="w-full h-full" fill="none" viewBox="0 0 24 24">
        <path d={svgPaths.p6a6600} fill="currentColor" className="text-foreground" />
      </svg>
    </div>
  );
}

function MessagePlusIcon() {
  return (
    <div className="w-6 h-6">
      <svg className="w-full h-full" fill="none" viewBox="0 0 24 24">
        <path d={svgPaths.p1b14c680} fill="currentColor" className="text-foreground" />
      </svg>
    </div>
  );
}

function ChevronDownIcon() {
  return (
    <div className="w-5 h-5">
      <svg className="w-full h-full" fill="none" viewBox="0 0 20 20">
        <path d={svgPaths.p34b75100} fill="currentColor" className="text-foreground" />
      </svg>
    </div>
  );
}

function ChatHeader() {
  return (
    <div className="w-full bg-background border-b border-border">
      <div className="flex items-center justify-between px-4 py-3">
        <button className="p-2 -ml-2">
          <MenuIcon />
        </button>
        
        <button className="p-2 -mr-2">
          <MessagePlusIcon />
        </button>
      </div>
    </div>
  );
}

// Input area components
function SendIcon() {
  return (
    <div className="w-6 h-6">
      <svg className="w-full h-full" fill="none" viewBox="0 0 24 24">
        <path d={svgPaths.p12d8b300} fill="currentColor" />
      </svg>
    </div>
  );
}

function ChatInput({ onSendMessage, onAttachmentClick }: { onSendMessage: (message: string) => void, onAttachmentClick?: () => void }) {
  const [inputValue, setInputValue] = useState('');

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (inputValue.trim()) {
      onSendMessage(inputValue.trim());
      setInputValue('');
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSubmit(e);
    }
  };

  return (
    <div className="relative rounded-tl-[20px] rounded-tr-[20px] w-full bg-background">
      <div className="flex flex-col items-center justify-end relative w-full">
        <div className="box-border content-stretch flex flex-col gap-[24px] items-center justify-end pb-[24px] pt-[16px] px-[12px] relative w-full">
          <form onSubmit={handleSubmit} className="content-stretch flex gap-[8px] items-end justify-center relative w-full">
            {/* Input Field */}
            <div className="basis-0 bg-muted grow min-h-px min-w-px relative rounded-[24px] shrink-0">
              <div className="flex flex-row items-end relative size-full">
                <div className="box-border content-stretch flex gap-px items-end pl-[16px] pr-[8px] py-[8px] relative w-full">
                  <textarea
                    value={inputValue}
                    onChange={(e) => setInputValue(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSubmit(e as any);
                      }
                    }}
                    placeholder="Type your question"
                    rows={1}
                    className="basis-0 grow min-h-[24px] max-h-[120px] min-w-px bg-transparent border-none outline-none text-foreground placeholder:text-muted-foreground resize-none overflow-y-auto"
                    style={{
                      fontSize: '16px',
                      lineHeight: '24px',
                      letterSpacing: '-0.3px',
                      scrollbarWidth: 'none',
                      msOverflowStyle: 'none'
                    }}
                    onInput={(e) => {
                      const textarea = e.target as HTMLTextAreaElement;
                      textarea.style.height = 'auto';
                      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
                    }}
                  />
                  {/* Paperclip Icon */}
                  <div className="box-border content-stretch flex gap-[10px] items-end p-[2px] relative shrink-0">
                    <button 
                      type="button"
                      onClick={onAttachmentClick}
                      className="relative shrink-0 size-[20px] hover:opacity-70 transition-opacity"
                    >
                      <svg className="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 20 20">
                        <g>
                          <path d="M17.8669 9.20832L10.2086 16.8666C9.27037 17.8049 7.99789 18.3319 6.67107 18.3319C5.34426 18.3319 4.07178 17.8049 3.13357 16.8666C2.19537 15.9284 1.66829 14.656 1.66829 13.3291C1.66829 12.0023 2.19537 10.7299 3.13357 9.79165L10.7919 2.13332C11.4174 1.50785 12.2657 1.15646 13.1502 1.15646C14.0348 1.15646 14.8831 1.50785 15.5086 2.13332C16.134 2.75879 16.4854 3.6071 16.4854 4.49165C16.4854 5.3762 16.134 6.22451 15.5086 6.84998L7.84191 14.5083C7.52917 14.8211 7.10501 14.9967 6.66274 14.9967C6.22047 14.9967 5.79631 14.8211 5.48357 14.5083C5.17084 14.1956 4.99515 13.7714 4.99515 13.3291C4.99515 12.8869 5.17084 12.4627 5.48357 12.15L12.5586 5.08332" stroke="var(--foreground)" strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.66667" />
                        </g>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            {/* Send Button */}
            <button
              type="submit"
              className={`transition-colors ${
                !inputValue.trim() 
                  ? 'bg-muted cursor-not-allowed' 
                  : 'bg-primary hover:bg-primary/90 active:bg-primary/80'
              } box-border content-stretch flex flex-col gap-[10px] items-end p-[8px] relative rounded-[1000px] shrink-0`}
              disabled={!inputValue.trim()}
            >
              <div className={`relative size-[24px] ${!inputValue.trim() ? 'text-foreground' : 'text-primary-foreground'}`}>
                <svg className="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 24 24">
                  <g>
                    <path clipRule="evenodd" d="M11.2926 4.29289C11.683 3.90237 12.3162 3.90237 12.7067 4.29289L16.7063 8.29289C17.0968 8.68342 17.0968 9.31658 16.7063 9.70711C16.3158 10.0976 15.6827 10.0976 15.2922 9.70711L12.9995 7.41421V19C12.9995 19.5523 12.5518 20 11.9996 20C11.4474 20 10.9997 19.5523 10.9997 19V7.41421L8.70697 9.70711C8.31648 10.0976 7.68336 10.0976 7.29287 9.70711C6.90238 9.31658 6.90238 8.68342 7.29287 8.29289L11.2926 4.29289Z" fill="currentColor" fillRule="evenodd" />
                  </g>
                </svg>
              </div>
            </button>
          </form>
        </div>
      </div>
    </div>
  );
}

// Main chat interface component
export function ChatInterface() {
  const [messages, setMessages] = useState<Message[]>([]);
  const [isTyping, setIsTyping] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const hasStartedRef = useRef(false);
  const [hasRespondedToNameQuestion, setHasRespondedToNameQuestion] = useState(false);
  const [userFirstName, setUserFirstName] = useState('');
  
  // Registration flow states
  const [registrationStarted, setRegistrationStarted] = useState(false);
  const [currentStep, setCurrentStep] = useState<'none' | 'shareholders-count' | 'shareholders-names' | 'shareholding-percentages' | 'shareholder-birthdate' | 'shareholder-citizenship' | 'business-activities' | 'company-names' | 'documents' | 'payment' | 'completed'>('none');
  const [shareholdersCount, setShareholdersCount] = useState(0);
  const [shareholderNames, setShareholderNames] = useState<string[]>([]);
  const [shareholderPercentages, setShareholderPercentages] = useState<number[]>([]);
  const [shareholderBirthdates, setShareholderBirthdates] = useState<string[]>([]);
  const [shareholderCitizenships, setShareholderCitizenships] = useState<string[]>([]);
  const [currentShareholderIndex, setCurrentShareholderIndex] = useState(0);
  const [waitingForCitizenship, setWaitingForCitizenship] = useState(false);
  const [businessActivities, setBusinessActivities] = useState<string[]>([]);
  const [waitingForBusinessActivities, setWaitingForBusinessActivities] = useState(false);
  const [companyNames, setCompanyNames] = useState<string[]>([]);
  const [waitingForCompanyNames, setWaitingForCompanyNames] = useState(false);
  const [documentsUploaded, setDocumentsUploaded] = useState(false);
  
  // Payment states
  const [isPaymentModalOpen, setIsPaymentModalOpen] = useState(false);
  const [showPaymentSuccess, setShowPaymentSuccess] = useState(false);

  // Handle payment click
  const handlePayClick = () => {
    setIsPaymentModalOpen(true);
  };

  // Handle payment success
  const handlePaymentSuccess = () => {
    setIsPaymentModalOpen(false);
    setShowPaymentSuccess(true);
    setCurrentStep('completed');
  };

  // Handle return to Adlex
  const handleReturnToAdlex = () => {
    setShowPaymentSuccess(false);
    // Reset all states or redirect to main app
    window.location.reload(); // Simple reset for demo
  };

  // Show payment success screen if needed
  if (showPaymentSuccess) {
    return <PaymentSuccess onReturnToAdlex={handleReturnToAdlex} />;
  }

  // Continue with rest of chat component logic...
  // (keeping the existing handlers and logic as they were)
  
  // Handle citizenship selection
  const handleCitizenshipSelect = (country: string) => {
    if (!waitingForCitizenship) return;
    
    setWaitingForCitizenship(false);
    const newCitizenships = [...shareholderCitizenships, country];
    setShareholderCitizenships(newCitizenships);
    
    const nextIndex = currentShareholderIndex + 1;
    
    if (nextIndex < shareholdersCount) {
      // Move to next shareholder
      setCurrentShareholderIndex(nextIndex);
      setCurrentStep('shareholding-percentages');
      
      const totalSoFar = shareholderPercentages.reduce((sum, p) => sum + p, 0);
      const remaining = 100 - totalSoFar;
      
      const nextMessage: Message = {
        id: (Date.now() + 2).toString(),
        content: `Perfect! **${shareholderNames[currentShareholderIndex]}** data collected.\\n\\nRemaining: ${remaining}%\\n\\n**What percentage of shares does ${shareholderNames[nextIndex]} hold?**`,
        isBot: true,
        timestamp: new Date(),
      };
      setMessages(prev => [...prev, nextMessage]);
    } else {
      // All shareholders completed - move to business activities
      const totalPercentage = shareholderPercentages.reduce((sum, p) => sum + p, 0);
      
      if (Math.abs(totalPercentage - 100) > 0.01) {
        const errorMessage: Message = {
          id: (Date.now() + 2).toString(),
          content: `The total percentage is ${totalPercentage}%, but it should equal 100%. Please adjust the percentages.`,
          isBot: true,
          timestamp: new Date(),
        };
        setMessages(prev => [...prev, errorMessage]);
        return;
      }
      
      // Move to business activities step
      setCurrentStep('business-activities');
      setWaitingForBusinessActivities(true);
      
      const activitiesMessage: Message = {
        id: (Date.now() + 2).toString(),
        content: '',
        isBot: true,
        timestamp: new Date(),
        hasBusinessActivitySelector: true,
      };
      setMessages(prev => [...prev, activitiesMessage]);
    }
  };

  // Handle business activities selection
  const handleBusinessActivitiesSelect = (activities: string[]) => {
    if (!waitingForBusinessActivities) return;
    
    setWaitingForBusinessActivities(false);
    setBusinessActivities(activities);
    setCurrentStep('company-names');
    setWaitingForCompanyNames(true);
    
    const nameSelectionMessage: Message = {
      id: (Date.now() + 3).toString(),
      content: '',
      isBot: true,
      timestamp: new Date(),
      hasCompanyNameSelector: true,
    };
    setMessages(prev => [...prev, nameSelectionMessage]);
  };

  // Handle company names selection
  const handleCompanyNamesSelect = (names: string[]) => {
    if (!waitingForCompanyNames) return;
    
    setWaitingForCompanyNames(false);
    setCompanyNames(names);
    setCurrentStep('documents');
    
    // Show documents request message
    const documentsMessage: Message = {
      id: (Date.now() + 4).toString(),
      content: '',
      isBot: true,
      timestamp: new Date(),
      hasDocumentsMessage: true,
    };
    setMessages(prev => [...prev, documentsMessage]);
  };

  // Handle attachment click (PDF upload)
  const handleAttachmentClick = () => {
    if (currentStep !== 'documents' || documentsUploaded) return;
    
    // Immediately send PDF message
    const pdfMessage: Message = {
      id: (Date.now() + 1).toString(),
      content: '',
      isBot: false,
      timestamp: new Date(),
      isPDFAttachment: true,
    };
    setMessages(prev => [...prev, pdfMessage]);
    setDocumentsUploaded(true);
    
    // Show payment message after short delay
    setTimeout(() => {
      setCurrentStep('payment');
      
      const paymentMessage: Message = {
        id: (Date.now() + 5).toString(),
        content: '',
        isBot: true,
        timestamp: new Date(),
        hasPaymentMessage: true,
      };
      setMessages(prev => [...prev, paymentMessage]);
    }, 1000);
  };

  // Initial messages queue
  const initialMessages = [
    'ðŸ‘‹ Welcome to Adlex.ai! I\\'ll be your personal AI assistant to guide you through opening your UAE company fully online.',
    'Let\\'s personalize your experience a little',
    '**What\\'s your first name?** I\\'ll use it to address you during our journey'
  ];

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  // Add initial messages sequentially with custom delays
  useEffect(() => {
    if (!hasStartedRef.current && initialMessages.length > 0) {
      hasStartedRef.current = true;
      
      // Custom delays: 500ms, 3500ms, 5500ms (500 + 3000 + 2000)
      const delays = [500, 3500, 5500];
      
      initialMessages.forEach((messageContent, index) => {
        setTimeout(() => {
          const newMessage: Message = {
            id: `initial-${index}`,
            content: messageContent,
            isBot: true,
            timestamp: new Date(),
          };
          setMessages(prev => [...prev, newMessage]);
        }, delays[index] || 0);
      });
    }
  }, []);

  // Bot response logic would continue here with all the existing logic...
  // (keeping all the existing getBotResponse function, handleSendMessage, etc.)

  const getBotResponse = (userMessage: string, isResponseToNameQuestion = false): Message => {
    const lowerMessage = userMessage.toLowerCase();
    const trimmedMessage = userMessage.trim();

    // Special response to name question
    if (isResponseToNameQuestion) {
      const firstName = trimmedMessage;
      setUserFirstName(firstName);
      
      return {
        id: (Date.now() + 1).toString(),
        content: `Nice to meet you, ${firstName}! I'm excited to help you on this journey. Let's get your UAE company registered step by step.`,
        isBot: true,
        timestamp: new Date(),
        hasButton: true,
        onButtonClick: () => {
          // Start registration flow
          setRegistrationStarted(true);
          setCurrentStep('shareholders-count');
          
          // Add first registration question
          setTimeout(() => {
            const registrationMessage: Message = {
              id: (Date.now() + 2).toString(),
              content: `Let's start!\\n\\n**Step 1 â€” Shareholder details**\\n\\nHow many shareholders are there in the company?`,
              isBot: true,
              timestamp: new Date(),
            };
            setMessages(prev => [...prev, registrationMessage]);
          }, 1000);
        }
      };
    }

    // Registration flow responses
    if (registrationStarted) {
      if (currentStep === 'shareholders-count') {
        const count = parseInt(trimmedMessage);
        if (isNaN(count) || count < 1 || count > 10) {
          return {
            id: (Date.now() + 1).toString(),
            content: 'Please enter a valid number of shareholders (between 1 and 10).',
            isBot: true,
            timestamp: new Date(),
          };
        }
        
        setShareholdersCount(count);
        setCurrentStep('shareholders-names');
        setShareholderNames([]);
        
        return {
          id: (Date.now() + 1).toString(),
          content: `Perfect! ${count} shareholder${count > 1 ? 's' : ''}.\\n\\nPlease provide the full name of ${count > 1 ? 'each shareholder (all names in one message)' : 'the shareholder'}.`,
          isBot: true,
          timestamp: new Date(),
        };
      }

      // Add all other registration flow logic here...
      // (keeping existing logic for other steps)
    }

    // Default response for other cases
    return {
      id: (Date.now() + 1).toString(),
      content: "I'm here to help with your UAE company registration. Please follow the steps above.",
      isBot: true,
      timestamp: new Date(),
    };
  };

  const handleSendMessage = (messageText: string) => {
    if (!messageText.trim()) return;

    // Create user message
    const userMessage: Message = {
      id: Date.now().toString(),
      content: messageText,
      isBot: false,
      timestamp: new Date(),
    };

    setMessages(prev => [...prev, userMessage]);

    // Check if this is first response (to name question)
    const isNameResponse = messages.length === 3 && !hasRespondedToNameQuestion;
    if (isNameResponse) {
      setHasRespondedToNameQuestion(true);
    }

    // Get bot response
    setTimeout(() => {
      const botResponse = getBotResponse(messageText, isNameResponse);
      setMessages(prev => [...prev, botResponse]);
    }, 500);
  };

  return (
    <div className="flex flex-col h-screen bg-background">
      <ChatHeader />
      
      <div className="flex-1 flex flex-col min-h-0">
        <div className="flex-1 overflow-y-auto px-4 py-6 space-y-4">
          {messages.map((message, index) => (
            <ChatMessage
              key={message.id}
              message={message}
              onCitizenshipSelect={handleCitizenshipSelect}
              onBusinessActivitiesSelect={handleBusinessActivitiesSelect}
              onCompanyNamesSelect={handleCompanyNamesSelect}
              onPayClick={handlePayClick}
              businessActivities={businessActivities}
              waitingForBusinessActivities={waitingForBusinessActivities}
            />
          ))}
          <div ref={messagesEndRef} />
        </div>
        
        <ChatInput onSendMessage={handleSendMessage} onAttachmentClick={handleAttachmentClick} />
      </div>

      {/* Payment Modal */}
      <PaymentModal 
        isOpen={isPaymentModalOpen}
        onClose={() => setIsPaymentModalOpen(false)}
        onPaymentSuccess={handlePaymentSuccess}
      />
    </div>
  );
}